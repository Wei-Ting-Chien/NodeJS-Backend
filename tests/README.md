# æ¸¬è©¦èªªæ˜æ–‡ä»¶

## ğŸ“‹ æ¸¬è©¦æ¶æ§‹æ¦‚è¿°

æœ¬å°ˆæ¡ˆä½¿ç”¨ **Mocha + Chai + Sinon + Supertest** æŠ€è¡“æ£§é€²è¡Œæ¸¬è©¦ï¼Œæ¸¬è©¦åˆ†ç‚ºä¸‰å€‹å±¤ç´šï¼š

- **Unit Tests** (`tests/unit/`): å–®å…ƒæ¸¬è©¦ï¼Œæ¸¬è©¦å€‹åˆ¥å‡½æ•¸æˆ–é¡åˆ¥
- **Integration Tests** (`tests/integration/`): æ•´åˆæ¸¬è©¦ï¼Œæ¸¬è©¦å¤šå€‹çµ„ä»¶é–“çš„å”ä½œ
- **E2E Tests** (`tests/e2e/`): ç«¯åˆ°ç«¯æ¸¬è©¦ï¼Œæ¸¬è©¦å®Œæ•´çš„ç”¨æˆ¶æµç¨‹

## ğŸš€ åŸ·è¡Œæ¸¬è©¦

### å‰ç½®éœ€æ±‚

1. ç¢ºä¿ Docker å®¹å™¨æ­£åœ¨é‹è¡Œï¼ˆPostgreSQL è³‡æ–™åº«ï¼‰
2. ç¢ºä¿ç’°å¢ƒè®Šæ•¸æ­£ç¢ºè¨­å®š

### åŸ·è¡ŒæŒ‡ä»¤

```bash
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
npm run test:all

# åŸ·è¡Œç‰¹å®šé¡å‹çš„æ¸¬è©¦
npm run test:unit
npm run test:integration
npm run test:e2e

# åŸ·è¡Œç‰¹å®šæª”æ¡ˆ
npm run test:integration -- --grep "ç”¨æˆ¶è¨»å†Š"

# ç›£è¦–æ¨¡å¼ï¼ˆé–‹ç™¼æ™‚ä½¿ç”¨ï¼‰
npm run test:watch

# ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š
npm run test:coverage
```

## ğŸ“ æ¸¬è©¦æª”æ¡ˆçµæ§‹

```
tests/
â”œâ”€â”€ config.js                           # æ¸¬è©¦ç’°å¢ƒé…ç½®
â”œâ”€â”€ setup.js                           # æ¸¬è©¦è¨­å®šå·¥å…·
â”œâ”€â”€ mocha.env.js                        # Mocha ç’°å¢ƒè¨­å®š
â”œâ”€â”€ README.md                           # æœ¬æª”æ¡ˆ
â”œâ”€â”€ unit/                               # å–®å…ƒæ¸¬è©¦
â”‚   â”œâ”€â”€ models/                         # Model å±¤æ¸¬è©¦
â”‚   â”œâ”€â”€ services/                       # Service å±¤æ¸¬è©¦
â”‚   â””â”€â”€ routes/                         # Route å±¤æ¸¬è©¦
â”œâ”€â”€ integration/                        # æ•´åˆæ¸¬è©¦
â”‚   â””â”€â”€ users.register.integration.spec.js  # ç”¨æˆ¶è¨»å†Šæ•´åˆæ¸¬è©¦
â””â”€â”€ e2e/                               # ç«¯åˆ°ç«¯æ¸¬è©¦
```

## ğŸ§ª ç”¨æˆ¶è¨»å†Šæ¸¬è©¦ (Integration)

### æ¸¬è©¦æª”æ¡ˆä½ç½®

`tests/integration/users.register.integration.spec.js`

### æ¸¬è©¦æ¡ˆä¾‹èªªæ˜

åŸºæ–¼ `vibe-story/13-test_spec.md` è¦æ ¼å¯¦ä½œï¼ŒåŒ…å«ä»¥ä¸‹ 8 å€‹æ¸¬è©¦æ¡ˆä¾‹ï¼š

| #   | æ¸¬è©¦æƒ…å¢ƒ           | æœŸæœ›ç‹€æ…‹ç¢¼ | æœŸæœ›å›æ‡‰            |
| --- | ------------------ | ---------- | ------------------- |
| 1   | âœ… æ­£å¸¸è¨»å†ŠæˆåŠŸ    | 200/201    | æˆåŠŸè¨Šæ¯ + ç”¨æˆ¶è³‡æ–™ |
| 2   | âŒ å¸³è™Ÿå·²å­˜åœ¨      | 400/409    | éŒ¯èª¤è¨Šæ¯            |
| 3   | âŒ Email å·²å­˜åœ¨    | 400/409    | éŒ¯èª¤è¨Šæ¯            |
| 4   | âŒ å¯†ç¢¼å¤ªçŸ­ (< 6)  | 400        | é©—è­‰éŒ¯èª¤è¨Šæ¯        |
| 5   | âŒ å¯†ç¢¼å¤ªé•· (> 12) | 400        | é©—è­‰éŒ¯èª¤è¨Šæ¯        |
| 6   | âŒ ç¼ºå°‘ username   | 400        | å¿…å¡«æ¬„ä½éŒ¯èª¤        |
| 7   | âŒ ç¼ºå°‘ email      | 400        | å¿…å¡«æ¬„ä½éŒ¯èª¤        |
| 8   | âŒ ç¼ºå°‘ password   | 400        | å¿…å¡«æ¬„ä½éŒ¯èª¤        |

### æ¸¬è©¦ç¯„åœ

- **API ç«¯é»**: `POST /users/register`
- **æ¸¬è©¦å±¤ç´š**: Route â†’ Service â†’ Repository â†’ Database
- **é©—è­‰é …ç›®**:
  - HTTP ç‹€æ…‹ç¢¼
  - å›æ‡‰æ ¼å¼
  - è³‡æ–™é©—è­‰
  - æ¥­å‹™é‚è¼¯
  - è³‡æ–™åº«æ“ä½œ

## ğŸ› ï¸ æ¸¬è©¦å·¥å…·èªªæ˜

### å…±ç”¨å·¥å…· (`tests/setup.js`)

- `setupTestDatabase()`: åˆå§‹åŒ–æ¸¬è©¦è³‡æ–™åº«é€£æ¥
- `cleanupTestData()`: æ¸…ç†æ¸¬è©¦è³‡æ–™ï¼Œç¢ºä¿æ¸¬è©¦é–“ç¨ç«‹æ€§
- `closeTestDatabase()`: é—œé–‰è³‡æ–™åº«é€£æ¥
- `createTestUserData()`: ç”¢ç”Ÿæ¸¬è©¦ç”¨æˆ¶è³‡æ–™
- `sleep()`: å»¶é²åŸ·è¡Œå·¥å…·

### æ¸¬è©¦é…ç½® (`tests/config.js`)

- ç’°å¢ƒè®Šæ•¸è¨­å®š
- è³‡æ–™åº«é…ç½®
- JWT è¨­å®š
- æ¸¬è©¦è¶…æ™‚è¨­å®š

## ğŸ”§ é–‹ç™¼æ¸¬è©¦æŒ‡å—

### æ–°å¢æ¸¬è©¦æª”æ¡ˆ

1. æ ¹æ“šæ¸¬è©¦é¡å‹é¸æ“‡é©ç•¶çš„è³‡æ–™å¤¾ (`unit/`, `integration/`, `e2e/`)
2. æª”æ¡ˆå‘½åæ ¼å¼: `[åŠŸèƒ½åç¨±].[æ¸¬è©¦é¡å‹].spec.js`
3. å¼•å…¥å¿…è¦çš„æ¸¬è©¦å·¥å…·å’Œè¨­å®š

### æ¸¬è©¦æ’°å¯«æœ€ä½³å¯¦è¸

1. **æ¸¬è©¦ç¨ç«‹æ€§**: æ¯å€‹æ¸¬è©¦æ‡‰è©²ç¨ç«‹é‹è¡Œï¼Œä¸ä¾è³´å…¶ä»–æ¸¬è©¦
2. **è³‡æ–™æ¸…ç†**: ä½¿ç”¨ `afterEach` æ¸…ç†æ¸¬è©¦è³‡æ–™
3. **æè¿°æ€§å‘½å**: æ¸¬è©¦åç¨±æ‡‰æ¸…æ¥šæè¿°æ¸¬è©¦æƒ…å¢ƒ
4. **é©ç•¶åˆ†çµ„**: ä½¿ç”¨ `describe` å°‡ç›¸é—œæ¸¬è©¦åˆ†çµ„
5. **é‚Šç•Œæ¸¬è©¦**: åŒ…å«æ­£å¸¸æƒ…æ³å’Œé‚Šç•Œæ¢ä»¶çš„æ¸¬è©¦

### Docker ç’°å¢ƒæ¸¬è©¦

æœ¬å°ˆæ¡ˆä½¿ç”¨ Docker åŸ·è¡Œæœå‹™ï¼Œæ¸¬è©¦æ™‚éœ€è¦ï¼š

1. ç¢ºä¿ Docker å®¹å™¨æ­£åœ¨é‹è¡Œ
2. è³‡æ–™åº«æœå‹™å¯æ­£å¸¸é€£æ¥
3. ç’°å¢ƒè®Šæ•¸æ­£ç¢ºè¨­å®š

```bash
# å•Ÿå‹• Docker æœå‹™
docker-compose up -d

# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker-compose ps

# åŸ·è¡Œæ¸¬è©¦
npm run test:integration
```

## ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡

åŸ·è¡Œ `npm run test:coverage` ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Šï¼Œå ±å‘ŠæœƒåŒ…å«ï¼š

- è¡Œè¦†è“‹ç‡ (Line Coverage)
- åˆ†æ”¯è¦†è“‹ç‡ (Branch Coverage)
- å‡½æ•¸è¦†è“‹ç‡ (Function Coverage)
- èªå¥è¦†è“‹ç‡ (Statement Coverage)

ç›®æ¨™è¦†è“‹ç‡: **â‰¥ 80%**

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **è³‡æ–™åº«é€£æ¥å¤±æ•—**
   - æª¢æŸ¥ Docker å®¹å™¨ç‹€æ…‹
   - é©—è­‰ç’°å¢ƒè®Šæ•¸è¨­å®š
   - ç¢ºèªç¶²è·¯é€£æ¥

2. **æ¸¬è©¦è¶…æ™‚**
   - èª¿æ•´ `.mocharc.json` ä¸­çš„ timeout è¨­å®š
   - æª¢æŸ¥è³‡æ–™åº«æŸ¥è©¢æ•ˆèƒ½

3. **æ¸¬è©¦é–“äº’ç›¸å½±éŸ¿**
   - ç¢ºä¿ä½¿ç”¨ `cleanupTestData()` æ¸…ç†è³‡æ–™
   - æª¢æŸ¥æ¸¬è©¦åŸ·è¡Œé †åº

### é™¤éŒ¯æŠ€å·§

```bash
# åŸ·è¡Œå–®ä¸€æ¸¬è©¦æª”æ¡ˆä¸¦é¡¯ç¤ºè©³ç´°è³‡è¨Š
npx mocha tests/integration/users.register.integration.spec.js --reporter spec

# åªåŸ·è¡Œç‰¹å®šæ¸¬è©¦æ¡ˆä¾‹
npx mocha tests/integration/users.register.integration.spec.js --grep "æ­£å¸¸è¨»å†ŠæˆåŠŸ"

# é–‹å•Ÿé™¤éŒ¯æ¨¡å¼
DEBUG=* npm run test:integration
```
