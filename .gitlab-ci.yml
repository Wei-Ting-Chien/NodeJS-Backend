image: alpine:3.18
services:
  - name: docker:dind
    command: ['--tls=false']

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ''
  DOCKER_DRIVER: overlay2

stages: [build, test]

before_script:
  - apk add --no-cache docker-cli docker-cli-compose curl
  - cp "$ENV_FILE_CI" .env.ci

build:
  stage: build
  script:
    - docker --version
    - docker compose version

    - docker compose -f docker-compose-gitci.yml up -d
    - docker ps

test:
  stage: test
  image: alpine:3.18
  services:
    - name: docker:dind
      command: ['--tls=false']
  variables:
    DOCKER_DRIVER: overlay2
    NODE_ENV: test
  script:
    # å®‰è£å·¥å…·
    - apk add --no-cache docker-cli docker-cli-compose curl
    - cp "$ENV_FILE_CI" .env.ci

    - docker compose -f docker-compose-gitci.yml up --abort-on-container-exit

    # å¦‚æœå¤±æ•—ï¼Œé¡¯ç¤ºå®¹å™¨æ—¥èªŒ
    - echo "ğŸ” Container logs after failure:"
    - docker logs social-api || true
    - docker logs social-db-ci || true
    - docker logs social-test || true

    # æ¸…ç†
    - docker compose -f docker-compose-gitci.yml down -v
